<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPal Zahlung erfolgreich - AutoR</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/navbar.css">
</head>
<body style="overflow-x: hidden; background:#f7f7f7;">
    <!-- Navigation -->
    <div id="navbar-container"></div>

    <!-- Success Section -->
    <section class="py-5" style="margin-top: 80px;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-6">
                    <div class="bg-white rounded-4 p-5 shadow-sm border text-center">
                        <div class="mb-4">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        </div>
                        
                        <h2 class="fw-bold text-success mb-3">PayPal Zahlung erfolgreich!</h2>
                        <p class="text-muted mb-4">Ihre Zahlung wurde erfolgreich verarbeitet. Sie werden in Kürze eine Bestätigungs-E-Mail erhalten.</p>
                        
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Wichtiger Hinweis:</strong> Dies ist eine Demo-Umgebung. In der Produktion würden Sie hier zur PayPal-Website weitergeleitet.
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <a href="/payment-success" class="btn btn-warning btn-lg">
                                <i class="bi bi-arrow-right me-2"></i>
                                Reservierung abschließen
                            </a>
                            <a href="/buchungen" class="btn btn-outline-secondary btn-lg">
                                <i class="bi bi-list me-2"></i>
                                Meine Buchungen
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="/js/navbar.js"></script>
    <script>
        // PayPal success callback işlemi
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('token');
            const payerId = urlParams.get('PayerID');
            const paymentId = urlParams.get('paymentId');
            
            if (orderId) {
                try {
                    // Backend'e success callback gönder
                    const response = await fetch('/api/payments/paypal/success', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            orderId: orderId,
                            payerId: payerId,
                            paymentId: paymentId
                        })
                    });
                    
                    const result = await response.json();
                    console.log('PayPal success callback result:', result);
                    
                    if (result.success) {
                        // Payment data'yı localStorage'a kaydet
                        localStorage.setItem('lastPayment', JSON.stringify(result.payment));
                        localStorage.setItem('paypalOrderId', orderId);
                        
                        // Reservation oluştur
                        await createReservationAfterPayPalPayment();
                    }
                } catch (error) {
                    console.error('PayPal success callback error:', error);
                }
            }
        });
        
        async function createReservationAfterPayPalPayment() {
            try {
                console.log('Creating reservation after PayPal payment...');
                
                // Reservation data'yı localStorage'dan al
                const reservationData = JSON.parse(localStorage.getItem('reservationData') || '{}');
                
                if (!reservationData.carId && !reservationData.vehicleId) {
                    console.error('No reservation data found');
                    return;
                }
                
                // User data'yı al
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (!userData.email) {
                    console.error('No user email found');
                    return;
                }
                
                // Reservation payload'ı hazırla
                const reservationPayload = {
                    userEmail: userData.email,
                    vehicleId: reservationData.carId || reservationData.vehicleId,
                    vehicleName: reservationData.vehicleName || reservationData.vehicle?.make + ' ' + reservationData.vehicle?.model || 'Unknown Vehicle',
                    vehicleImage: reservationData.vehicleImage || reservationData.vehicle?.image_url || '/images/cars/vw-t-roc-suv-4d-white-2022-JV.png',
                    pickupLocation: reservationData.pickupLocation || reservationData.pickupLocationName || 'Frankfurt am Main',
                    dropoffLocation: reservationData.dropoffLocation || reservationData.dropoffLocationName || reservationData.pickupLocation || 'Frankfurt am Main',
                    pickupDate: reservationData.pickupDate || '2024-01-15',
                    pickupTime: reservationData.pickupTime || '10:00',
                    dropoffDate: reservationData.dropoffDate || '2024-01-20',
                    dropoffTime: reservationData.dropoffTime || '10:00',
                    totalPrice: reservationData.totalPrice || 450,
                    basePrice: reservationData.basePrice || 400,
                    insurancePrice: reservationData.insurancePrice || reservationData.insuranceAmount || 30,
                    extrasPrice: reservationData.extrasPrice || reservationData.extrasAmount || 20,
                    insuranceType: reservationData.insuranceType || 'Standard',
                    extras: reservationData.extras || []
                };
                
                console.log('Reservation payload:', reservationPayload);
                
                // Reservation oluştur
                const response = await fetch('/api/reservations/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reservationPayload)
                });
                
                const result = await response.json();
                console.log('Reservation created:', result);
                
                if (result.success) {
                    // Payment status'u güncelle
                    await updatePaymentStatus(result.reservation.booking_id, 'completed');
                    
                    // User bookings'e kaydet
                    saveToUserBookings(result.reservation, 'completed');
                    
                    console.log('Reservation and payment completed successfully');
                } else {
                    console.error('Failed to create reservation:', result.message);
                }
                
            } catch (error) {
                console.error('Error creating reservation after PayPal payment:', error);
            }
        }
        
        async function updatePaymentStatus(bookingId, paymentStatus) {
            try {
                const response = await fetch(`/api/reservations/${bookingId}/payment-status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ paymentStatus })
                });
                
                const result = await response.json();
                console.log('Payment status updated:', result);
                return result;
            } catch (error) {
                console.error('Error updating payment status:', error);
                return { success: false, error: error.message };
            }
        }
        
        function saveToUserBookings(reservation, paymentStatus) {
            try {
                let userBookings = JSON.parse(localStorage.getItem('userBookings') || '[]');
                
                const bookingData = {
                    bookingId: reservation.booking_id,
                    vehicleId: reservation.vehicle_id,
                    vehicleName: reservation.vehicle_name,
                    vehicleImage: reservation.vehicle_image,
                    pickupLocation: reservation.pickup_location,
                    dropoffLocation: reservation.dropoff_location,
                    pickupDate: reservation.pickup_date,
                    pickupTime: reservation.pickup_time,
                    dropoffDate: reservation.dropoff_date,
                    dropoffTime: reservation.dropoff_time,
                    totalPrice: reservation.total_price,
                    basePrice: reservation.base_price,
                    insurancePrice: reservation.insurance_price,
                    extrasPrice: reservation.extras_price,
                    insuranceType: reservation.insurance_type,
                    extras: reservation.extras,
                    status: reservation.status || 'confirmed',
                    paymentStatus: paymentStatus,
                    createdAt: reservation.created_at || new Date().toISOString()
                };
                
                userBookings.unshift(bookingData);
                localStorage.setItem('userBookings', JSON.stringify(userBookings));
                console.log('Booking saved to localStorage');
            } catch (error) {
                console.error('Error saving booking to localStorage:', error);
            }
        }
    </script>
</body>
</html>
