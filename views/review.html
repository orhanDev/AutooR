<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Übersicht & Buchen – TurboMiete</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
  <div id="navbar-container">
    <!-- Navbar JavaScript ile yüklenecek -->
  </div>
  <main class="container my-4">
    <div class="row g-3">
      <aside class="col-lg-4">
        <div class="card p-3">
          <h6>Reiseübersicht</h6>
          <div id="trip-summary" class="small"></div>
          <hr/>
          <div class="d-flex justify-content-between"><span>Fahrzeug</span><span id="price-car">€0,00</span></div>
          <div class="d-flex justify-content-between"><span>Extras</span><span id="price-extras">€0,00</span></div>
          <div class="d-flex justify-content-between fw-semibold mt-2"><span>Gesamt</span><span id="price-total">€0,00</span></div>
        </div>
      </aside>
      <section class="col-lg-8">
        <div class="card p-3">
          <h5>Kontakt Details</h5>
          <div class="row g-2">
            <div class="col-md-6"><input id="r-first" class="form-control" placeholder="Vorname"/></div>
            <div class="col-md-6"><input id="r-last" class="form-control" placeholder="Nachname"/></div>
            <div class="col-md-6"><input id="r-email" class="form-control" placeholder="E-Mail"/></div>
            <div class="col-md-6"><input id="r-phone" class="form-control" placeholder="Telefon"/></div>
          </div>
          <hr/>
          <h5>Zahlung</h5>
          <p class="small text-muted">Bezahlung erfolgt sicher bei Abholung oder Online je nach gewählter Methode.</p>
          <button id="btn-book" class="btn btn-success">Jetzt buchen</button>
        </div>
      </section>
    </div>
  </main>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const carId = localStorage.getItem('selected_car_id');
      const pickupName = localStorage.getItem('pickup_location_name') || '';
      const dropoffName = localStorage.getItem('dropoff_location_name') || '';
      const pickupDate = localStorage.getItem('pickup_date') || '';
      const dropoffDate = localStorage.getItem('dropoff_date') || '';
      const pickupTime = localStorage.getItem('pickup_time') || '';
      const dropoffTime = localStorage.getItem('dropoff_time') || '';
      const days = Number(localStorage.getItem('days') || 1);
      const extrasTotal = Number(localStorage.getItem('extras_total') || 0);
      const res = await fetch('/api/cars/' + carId);
      const car = await res.json();
      const carTotal = Number(car.daily_rate || 0) * days;
      document.getElementById('trip-summary').innerHTML = `
        <div>Abholung: <strong>${pickupName}</strong></div>
        <div>${pickupDate} ${pickupTime}</div>
        <div class="mt-2">Rückgabe: <strong>${dropoffName}</strong></div>
        <div>${dropoffDate} ${dropoffTime}</div>`;
      document.getElementById('price-car').textContent = `€${carTotal.toLocaleString('de-DE', { minimumFractionDigits: 2 })}`;
      document.getElementById('price-extras').textContent = `€${extrasTotal.toLocaleString('de-DE', { minimumFractionDigits: 2 })}`;
      const total = carTotal + extrasTotal;
      document.getElementById('price-total').textContent = `€${total.toLocaleString('de-DE', { minimumFractionDigits: 2 })}`;

      // Prefill contact
      document.getElementById('r-first').value = localStorage.getItem('contact_first') || '';
      document.getElementById('r-last').value = localStorage.getItem('contact_last') || '';
      document.getElementById('r-email').value = localStorage.getItem('contact_email') || '';
      document.getElementById('r-phone').value = localStorage.getItem('contact_phone') || '';

      document.getElementById('btn-book').addEventListener('click', async () => {
        const token = localStorage.getItem('token');
        if(!token){ alert('Bitte zuerst anmelden.'); return; }
        try {
          const body = {
            car_id: carId,
            pickup_location_id: localStorage.getItem('pickup_location_id'),
            dropoff_location_id: localStorage.getItem('dropoff_location_id'),
            pickup_date: pickupDate,
            dropoff_date: dropoffDate,
            pickup_time: pickupTime || '09:00',
            dropoff_time: dropoffTime || '09:00',
            extras: JSON.parse(localStorage.getItem('extras_selected') || '[]'),
            total_price: total,
            status: 'Beklemede'
          };
          const resp = await fetch('/api/reservations', { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-auth-token': token }, body: JSON.stringify(body) });
          if(!resp.ok) throw new Error('Reservierung fehlgeschlagen');
          window.location.href = '/views/reservation_confirmation.html';
        } catch (e) {
          alert('Buchung fehlgeschlagen.');
        }
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/navbar.js"></script>
  <script src="/js/auth.js"></script>
</body>
</html>


